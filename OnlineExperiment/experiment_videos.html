<!DOCTYPE html>
<html>
<head>
    <title>NICE Validation</title>
    <meta charset="utf-8"/> 
    <script src="https://unpkg.com/jspsych@7.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@1.1.0"></script>
      <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
    <link href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

    /* elements to include */
    // integration with prolific - added
    // information sheet
    // consent form
    // instructions
    // task stimuli
    // manipulation check (did they watch the videos?)
    // survey per stimuli
    // psychometric
    // demographic
    // redirect to prolific
 
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
        override_safe_mode: true,
        on_finish: function () {
            jsPsych.data.displayData();

            /* redirect to prolific for thank you etc
             disabled during the development */

            // window.location = "https://app.prolific.co/submissions/complete?cc=XXXXXXX"

        }
    });

    // capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

      jsPsych.data.addProperties({
        subject_id: subject_id,
        study_id: study_id,
        session_id: session_id
      });

    /* create timeline */
    var timeline = [];


    // to manually preload media files, create an array of file paths for each 
    // media type
    var path = "/Users/panosmavros/Dropbox/FCL_Panos/01_Projects/NICE/NICE_Group-Folder/3_materials/videos/"
    var  videos = [
        '9convert.com - Walking New York City on a Springlike Day Manhattan NYC Waking Tour.mp4_1.mp4',
        '9convert.com - Walking New York City on a Springlike Day Manhattan NYC Waking Tour.mp4_2.mp4',
        '9convert.com - Walking New York City on a Springlike Day Manhattan NYC Waking Tour.mp4_3.mp4',
        '9convert.com - Walking New York City on a Springlike Day Manhattan NYC Waking Tour.mp4_4.mp4'
    ];

    videos.forEach(prependPath);

    function prependPath(item, index, arr) {
          return arr[index]  =  path + item;
    }

    // these array can be passed into the preload plugin using the images, audio 
    // and video parameters
     /* preload images */
    var preload = {
        type: jsPsychPreload,
        videos: videos
    };
    timeline.push(preload);

    /* define welcome message trial */
    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome);

    /* define instructions trial */
    var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
        <p>In this experiment, a circle will appear in the center
        of the screen.</p><p>If the circle is <strong>blue</strong>,
        press the letter F on the keyboard as fast as you can.</p>
        <p>If the circle is <strong>orange</strong>, press the letter J
        as fast as you can.</p>
        <div style='width: 700px;'>
        <div style='float: left;'><img src='stimuli/blue.png'></img>
        <p class='small'><strong>Press the F key</strong></p></div>
        <div style='float: right;'><img src='stimuli/orange.png'></img>
        <p class='small'><strong>Press the J key</strong></p></div>
        </div>
        <p>Press any key to begin.</p>
      `,
        post_trial_gap: 500
    };
    // timeline.push(instructions);

    /* define fixation and test trials */
    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: function () {
            return jsPsych.randomization.sampleWithoutReplacement([250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
        },
        data: {
            task: 'fixation'
        }
    };


    var likert_scale = [ 
      "Strongly Disagree", 
      "Disagree", 
      "Neutral", 
      "Agree", 
      "Strongly Agree"
    ];


    // survey
    var survey = {
      type: jsPsychSurveyLikert,
      questions: [
        {prompt: "Question 1", name: 'Vegetables', labels: likert_scale},
        {prompt: "Question 2", name: 'Fruit', labels: likert_scale},
        {prompt: "Question 3", name: 'Meat', labels: likert_scale},
      ],
      randomize_question_order: true
    };

    /* define trial stimuli array for timeline variables */
    var test_stimuli = [
        { stimulus: "stimuli/fish.mp4", correct_response: 'NO_KEYS' },
        { stimulus: "stimuli/fish.mp4", correct_response: 'NO_KEYS' }

    ];

    // video trials 
    // these video files cannot be automatically preloaded because they are passed 
    // into a trial using the jsPsych.timelineVariable function
    var video_trials = {
            type: jsPsychVideoKeyboardResponse,
            stimulus: jsPsych.timelineVariable('stimulus') , // can't get this to work properly !!
            choices: 'NO_KEYS',  // ['y', 'n'],
            data: {
                task: 'stimulus',
                // perhaps here we ask them a question to ensure they were paying attention
                correct_response: jsPsych.timelineVariable('correct_response')
            },
            trial_ends_after_video: true,
            on_finish: function (data) {
                data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
            }
    }




    /* define test procedure */
    var test_procedure = {
        timeline: [fixation, video_trials, survey],
        timeline_variables: test_stimuli,
        repetitions: 5,
        randomize_order: true
    };
    timeline.push(test_procedure);

    /* define debrief */
    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {

            var trials = jsPsych.data.get().filter({ task: 'response' });
            var correct_trials = trials.filter({ correct: true });
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            var rt = Math.round(correct_trials.select('rt').mean());

            return `<p>You responded correctly on ${accuracy}% of the trials.</p>
          <p>Your average response time was ${rt}ms.</p>
          <p>Press any key to complete the experiment. Thank you!</p>`;

        }
    };
    // timeline.push(debrief_block);


    var final_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>You've finished the last task. Thanks for participating!</p>
    <p><a href="https://app.prolific.co/submissions/complete?cc=XXXXXXX">Click here to return to Prolific and complete the study</a>.</p>`,
        choices: "NO_KEYS"
        }
    timeline.push(final_trial);

    /* start the experiment */
    jsPsych.run(timeline);

</script>

</html>